<!DOCTYPE html>
<html>
<head>
<title>WCA Scrambler</title>

<script type="text/javascript" src="/scrambler-interface/js/ui.js"></script>
<link type="text/css" href="/scrambler-interface/css/ui.css" rel="stylesheet" />

<script type="text/javascript" src="/js/scramble.js"></script>

<script type="text/javascript">
(function() {
	var scrambleServer = new tnoodle.ScrambleServer();

	function toScrambleRequest(sheets) {
		var scrambleRequest = [];
		for(var i = 0; i < sheets.length; i++) {
			var sheet = sheets[i];
			var scrambles = scramblesByGuid[sheet.guid];
			assert(scrambles.length >= sheet.scrambleCount);
			// It's possible we generated more scrambles than we actually need.
			scrambles = scrambles.slice(0, sheet.scrambleCount);
			var request = {
				scrambles: scrambles,
				copies: 1, //TODO - add support for this to ui.js
				scrambler: sheet.puzzle,
				count: sheet.scrambleCount,
				title: sheet.title,
				fmc: sheet.fmc
			};
			scrambleRequest.push(request);
		}
		return scrambleRequest;
	}
	function showZip(e) {
		var title = mark2.ui.getTitle();
		var sheets = mark2.ui.getScrambleSheets();
		var request = toScrambleRequest(sheets);
		var password = mark2.ui.getPassword();
		if(e.shiftKey) {
			scrambleServer.showPdf(title, request, password, "_blank");
		} else {
			scrambleServer.showZip(title, request, password, "");
		}
	}

	var scramblesByGuid, title;
	function clear() {
		scramblesByGuid = {};
		title = "";
	}
	clear();

	function scramblesLoaded(sheet, newScrambles) {
		scramblesByGuid[sheet.guid] = newScrambles;
		mark2.ui.scramblesGenerated(scramblesByGuid);

		// Perhaps there's more work to be done
		competitionChanged();
	}

	var oldPassword = null;
	function competitionChanged() {
		if(oldPassword != mark2.ui.getPassword()) {
			// All the scrambles we've generated were seeded based on
			// the old password. Since that password has changed, we must
			// throw out all our scrambles and try again.
			scramblesByGuid = {};
			oldPassword = mark2.ui.getPassword();
			mark2.ui.scramblesGenerated(scramblesByGuid);
		}
		var sheets = mark2.ui.getScrambleSheets();
		for(var i = 0; i < sheets.length; i++) {
			var sheet = sheets[i];
			var scrambles = scramblesByGuid[sheet.guid] || [];
			scramblesByGuid[sheet.guid] = scrambles;

			if(scrambles.length >= sheet.scrambleCount) {
				// We could truncate the scrambles array here, but that's work, and
				// we might be able to use the scrambles later anyways.
				continue;
			}

			// We don't have enough scrambles for this guid.
			// Since we're seeding, we nuke the existing scrambles and generate
			// the correct number.
			var neededScrambles = sheet.scrambleCount;
			var MAX_SCRAMBLES_PER_ROUND = 100;
			if(neededScrambles > MAX_SCRAMBLES_PER_ROUND) {
				alert("We don't currently support more than " + MAX_SCRAMBLES_PER_ROUND + " scrambles in a round, sorry!");
				return;
			}
			scrambles = [];
			for(var j = 0; j < neededScrambles; j++) {
				scrambles.push(null);
			}

			var seed = null;
			if(mark2.ui.getPassword()) {
				// We could see with the GUID, but then anyone could recreate these scrambles
				// if they know the name of the competition. Instead, we only seed the scrambles
				// if we were given a password, as this gives us something unguessable in the
				// seed.
				seed = sheet.guid + mark2.ui.getPassword();
			}
			scrambleServer.loadScrambles(scramblesLoaded.bind(null, sheet), sheet.puzzle, seed, neededScrambles);
		}
	}

	var removeTempDiv = function() {
		var tempDiv = document.getElementById("temp_div");
		document.body.removeChild(tempDiv);
	};

	var callbacks = {
		showScrambles: showZip,
		competitionChanged: competitionChanged
	};
	
	window.addEventListener('load', function() {
		var tnoodleLinkSpan = document.createElement('span');
		var tnoodleLink = document.createElement('a');
		tnoodleLink.href = '/readme';
		tnoodleLink.appendChild(document.createTextNode("TNoodle"));
		tnoodleLinkSpan.appendChild(tnoodleLink);
		tnoodleLinkSpan.appendChild(document.createTextNode(" WCA Scrambler"));
		var div = mark2.ui.initialize(tnoodleLinkSpan, callbacks);
		removeTempDiv();
		document.body.appendChild(div);
	}, false);

})();
</script>

</head>
<body>

<div id="temp_div" style="text-align: center; margin: 2em; font-family: sans-serif; font-size: 20px;">
	Loading scramble interface...
</div>

</body>
</html>
